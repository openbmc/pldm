{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "f20ca807_c5e31dbf",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1000945
      },
      "writtenOn": "2024-11-27T08:33:36Z",
      "side": 1,
      "message": "Get-Property when the object is removed will cause the error log. Can we use different to check the available of object instead of read it directly?",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "99c864d1_9345cea0",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1002134
      },
      "writtenOn": "2024-11-28T15:58:07Z",
      "side": 1,
      "message": "I understand your concern.\nCould you please clarify what method you mean by \"different\"?\nIf it involves using getsubtree and comparing, I worry that it might still result in inconsistencies with the actual MCTP tree.\n\nThank you very much for your suggestion.",
      "parentUuid": "f20ca807_c5e31dbf",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "28da6110_b0958175",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1002134
      },
      "writtenOn": "2024-11-28T16:02:26Z",
      "side": 1,
      "message": "I have tried using the same method as handling the interface added signal to read the remove signal with msg.read, in order to accurately delete the PLDM device corresponding to the EID that was actually removed.\nHowever, I found that errors such as \"no such device\" or \"address\" would occur.",
      "parentUuid": "99c864d1_9345cea0",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4ee144d2_3b0d7b96",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1000945
      },
      "writtenOn": "2024-11-29T03:25:37Z",
      "side": 1,
      "message": "Do you mean the `GetSubTree` and `GetSubTreePaths` does not response all of EP object paths?\n\n```\nvoid MctpDiscovery::removeEndpoints(sdbusplus::message_t\u0026)\n{\n    MctpInfos mctpInfos;\n    MctpInfos removedInfos;\n    std::map\u003cMctpInfo, Availability\u003e currentMctpInfoMap;\n    getMctpInfos(currentMctpInfoMap);\n    for (const auto\u0026 mapIt : currentMctpInfoMap)\n    {\n        mctpInfos.push_back(mapIt.first);\n    }\n    removeFromExistingMctpInfos(mctpInfos, removedInfos);\n    handleRemovedMctpEndpoints(removedInfos);\n}\n```\nIn the current pldmd code, to identify the removed MCTP object paths, we check the available MCTP EP object paths by call `getSubtree` method. Then comparing the stored object paths with currently available object paths to find the removed ones.\nI wonder how the object still available in `handleRemovedMctpEndpoints` steps?\n\nIs it because `getSubtree` in `getMctpInfos` does not work correctly? Does it missed some available EP object path?",
      "parentUuid": "28da6110_b0958175",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fb861349_4d13ef41",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1002134
      },
      "writtenOn": "2024-11-29T08:53:04Z",
      "side": 1,
      "message": "Yes, it seems the current `getSubtree` function is not working correctly.\n\nFrom my understanding, `pldm` uses `getSubtree` to determine the available object paths and then removes the object paths in `existingMctpInfos` that are not in `getSubtree`.\n\nHowever, it appears that the available object paths obtained from `getSubtree` may not be accurate, causing `pldm` to mistakenly remove available object paths.\n\nWith my commit applied, if the `getSubtree` results are accurate, the code should reach:\n\n```cpp\ncatch (const sdbusplus::exception::SdBusError\u0026 e)\n{\n    removedInfos.emplace_back(mctpInfo);\n}\n```\n\nbecause those object paths are actually not available. \nBut in our system, it is possible to reach:\n\n```cpp\ntry\n{\n    pldm::utils::DBusHandler().getDbusPropertyVariant(MCTPObject.c_str(), \"EID\", MCTPInterface);\n    info(\"Endpoint with EID \u0027{EID}\u0027 exists at object path \u0027{OBJECT}\u0027, not removing\",\n         \"EID\", std::get\u003c0\u003e(mctpInfo), \"OBJECT\", MCTPObject);\n}\n```\n\nwhich prints the additional debug message I added.\n\nAdditionally, in our system, when performing a 12V off on a server board, multiple MCTP EIDs are removed almost simultaneously.\nI have observed that the `getSubtree` results can be inconsistent during these instances.",
      "parentUuid": "4ee144d2_3b0d7b96",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "988c1dd4_2cc58d4d",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1002134
      },
      "writtenOn": "2024-11-29T09:01:33Z",
      "side": 1,
      "message": "The results of getSubtree are sometimes inconsistent with the actual situation. When this happens, it can lead to the erroneous removal of existing pldm devices.",
      "parentUuid": "fb861349_4d13ef41",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "40b0cc44_9e317e73",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1000945
      },
      "writtenOn": "2024-11-29T09:26:51Z",
      "side": 1,
      "message": "Can you ask Patric about that inconsistent of `GetSubTree` in discord?\nApplied this patch set will cause the D-Bus error message every time we remove one MCTP endpoint from D-Bus. That is unexpected behavior for `pldmd`.\nCan you try to use `dbus-monitor` to watch the MCTP signal to confirm there is no \"AddInterfaces\" signals for removing EP before `pldmd` remove the EP from watch list?",
      "parentUuid": "988c1dd4_2cc58d4d",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "14342426_ad6351ce",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1000945
      },
      "writtenOn": "2024-11-29T09:35:35Z",
      "side": 1,
      "message": "If the `GetSubTree` is inconsistent, I would like to use other solution to find the available MCTP EP D-Bus object paths to identify the removed EP correctly, rather than try to get the property of the removed EP which causes error message for each of removed EP. What do you think about that?",
      "parentUuid": "40b0cc44_9e317e73",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4b069737_96d37dc5",
        "filename": "requester/mctp_endpoint_discovery.cpp",
        "patchSetId": 6
      },
      "lineNbr": 172,
      "author": {
        "id": 1002134
      },
      "writtenOn": "2024-12-04T09:23:25Z",
      "side": 1,
      "message": "Sorry for the late reply.\nI noticed that `getSubTree` seems to be retrieving MCTP EP D-Bus objects that have already been removed, rather than missing existing ones.\nThis causes an error during `getMctpInfos`:\n\n```\n   error(\n        \"Error reading MCTP Endpoint property at path \u0027{PATH}\u0027 and service \u0027{SERVICE}\u0027, error - {ERROR}\",\n        \"ERROR\", e, \"SERVICE\", service, \"PATH\", path);\n}\n\n```\n\nThis error leads to a return, preventing PLDM from obtaining subsequent MCTP EP D-Bus object information and removing them.\n\nHowever, I noticed that your recent merge (https://gerrit.openbmc.org/c/openbmc/pldm/+/73005) removed the following code:\n\n```cpp\ncatch (const sdbusplus::exception_t\u0026 e)\n{\n    error(\n        \"Error reading MCTP Endpoint property at path \u0027{PATH}\u0027 and service \u0027{SERVICE}\u0027, error - {ERROR}\",\n        \"ERROR\", e, \"SERVICE\", service, \"PATH\", path);\n    return;\n}\n```\n\nI believe that without returning on read failure, we might successfully retrieve all existing MCTP EP D-Bus objects without erroneously removing them.\nTherefore, this commit might no longer be necessary.\n\nI will verify this on the latest PLDM version, including the changes from 73005.\n\nThank you very much.",
      "parentUuid": "14342426_ad6351ce",
      "revId": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}